## 消息队列扫盲

维基百科上的描述：在计算机科学中，消息队列（Message queue）是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常是来自用户。 这个描述很生硬，对于没有接触过消息队列的你来说可能有点不好理解。

其实消息队列在上世纪八九十年代就有了，只不过它最早并不是用在目前我们所熟悉的互联网集群架构中。最近十几年，互联网发展太快，用户群体越来越大，早期的简单架构早就不能满足需求。所以聪明的架构师们，想尽各种办法解决一切瓶颈，其中消息队列就是一个典型代表。它目前被广泛使用在异步通信领域里。

什么叫异步？举个例子，用户在网站注册一个账号，需要通过邮件确认。正确的步骤是：1）用户填写信息（包括邮箱地址）；2）服务器接收用户信息，写到数据库；3）服务器发送确认邮件给用户；4）网站提示用户注册完成。如果这4个步骤逐次完成，则整个流程耗费时间最大的是第三步，有可能需要不到1秒钟，也可能需要1分钟。所以，这样的设计最终会导致个别用户的不耐烦而放弃注册。

如果是异步的思路，那么会把第3步单独摘出来，也就是说不管用户有没有收到邮件，网站都会直接告诉用户注册成功了。这个设计没毛病，但是如何实现异步？这就用到了“消息队列”中间件。还接着说上面的小例子，在第二步的时候，服务器（其实是某个进程）除了将用户信息写入到数据库之外，它还会把用户的邮箱地址写入到消息队列里，而发送邮件的服务会到消息队列里取这个邮箱地址，然后再发邮件给那个邮箱地址。在这个过程中，写消息队列的服务（某个进程）和读消息队列的服务（发邮件的那个服务）没有直接关系，它们只需要专心写和读消息队列即可。

以上小例子，就是消息队列非常典型的一个应用场景。除了这种场景外，它还可以用在流量削峰的场景下。我想，你应该经历过双11淘宝秒抢商品吧，这个其实就是流量削峰。假如正常情况下一个网站架构最多承载1w人同时访问，但做活动时同时在线的人达到了100w，这时候要么增加服务器，要么限制在线活动的人。增加服务器的话，要考虑成本，一年就一次这样的大型活动，总不能为了这一次而增加99倍的设备，一点都不现实，所以只好限制在线活动的人数了。如何实现？消息队列可以做到，做活动时，先让大家排队，只放行1w人进入到消息队列里，而在消息队列里的这些人才可以进入到下一步的商品支付环节。进入消息队列的人支付完成，消息队列里面的人数减少，继续放行新的人进到消息队列里。

消息队列另外一个典型应用场景是解耦合，关于解耦合简单讲就是把本关联在一起的两个步骤拆分开，中间通过一个消息队列服务完成最终的通信，这其实也算是一种异步机制。

### 消息队列缺点

由于消息队列的异步特性，直接提升了整个架构的处理效率，提升了用户体验。但凡事都有两面性，消息队列在带来性能提升的同时也伴随着缺陷。

* 系统可用性降低

	毕竟在整个架构中，我们单独加了一个消息队列中间件，所以增加了风险，如果消息队列服务挂掉，势必会影响到整个架构。


* 系统复杂性提高

	本来非常简单的一个逻辑设计，但偏偏要在中间插入一个消息队列，所以这增加了程序员的工作量，需要考虑如何保证消息没有被重复消费、消息有没有丢失、消息顺序等细节问题。

* 数据一致性无法保证

	消息如果没有正确写入到消息队列里，或者说读取消息的服务并没有正确读取到消息，这都会影响到数据的一致性。

### 消息队列点名

















